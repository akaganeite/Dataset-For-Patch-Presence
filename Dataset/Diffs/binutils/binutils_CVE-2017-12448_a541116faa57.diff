diff --git a/bfd/ChangeLog b/bfd/ChangeLog
index 1bba9454096e..7be3d8267a71 100644
--- a/bfd/ChangeLog
+++ b/bfd/ChangeLog
@@ -21,6 +21,11 @@
 	(GET_VALUE_IN_FIELD): New macro.
 	(xcoff64_slurp_armap): Use new macros.
 
+	PR 21787
+	* archive.c (bfd_generic_archive_p): If the bfd does not have the
+	correct magic bytes at the start, set the error to wrong format
+	and clear the format selector before returning NULL.
+
 2017-09-04  Alan Modra  <amodra@gmail.com>
 
 	PR 22067
diff --git a/bfd/archive.c b/bfd/archive.c
index f209babe149f..885bf489c024 100644
--- a/bfd/archive.c
+++ b/bfd/archive.c
@@ -834,7 +834,12 @@ bfd_generic_archive_p (bfd *abfd)
   if (strncmp (armag, ARMAG, SARMAG) != 0
       && strncmp (armag, ARMAGB, SARMAG) != 0
       && ! bfd_is_thin_archive (abfd))
-    return NULL;
+    {
+      bfd_set_error (bfd_error_wrong_format);
+      if (abfd->format == bfd_archive)
+	abfd->format = bfd_unknown;
+      return NULL;
+    }
 
   tdata_hold = bfd_ardata (abfd);
 
